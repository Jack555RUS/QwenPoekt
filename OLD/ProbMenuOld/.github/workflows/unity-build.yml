# =============================================================================
# GitHub Actions Workflow –¥–ª—è —Å–±–æ—Ä–∫–∏ Unity –ø—Ä–æ–µ–∫—Ç–∞
# =============================================================================
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–∏ push –≤ main –∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–ª–∏–∑–∞
# =============================================================================

name: Unity Build

on:
  push:
    branches: [ "main", "develop" ]
    paths:
      - 'DragRaceUnity/**'
      - '.github/workflows/unity-build.yml'
  
  pull_request:
    branches: [ "main" ]
    paths:
      - 'DragRaceUnity/**'
  
  release:
    types: [published]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  workflow_dispatch:
    inputs:
      build_configuration:
        description: '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏'
        required: true
        default: 'Release'
        type: choice
        options:
          - Release
          - Development

# =============================================================================
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
# =============================================================================
env:
  UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
  UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
  UNITY_VERSION: 6000.3.10f1
  PROJECT_PATH: ./DragRaceUnity
  BUILD_PATH: ./Builds/GitHub-Actions

jobs:
  # =============================================================================
  # –ó–∞–¥–∞—á–∞ 1: –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  # =============================================================================
  validate:
    name: Validate Project
    runs-on: windows-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Check Unity Project Structure
        run: |
          if (!(Test-Path "DragRaceUnity/Assets")) {
            Write-Error "Unity project not found!"
            exit 1
          }
          if (!(Test-Path "DragRaceUnity/Packages/manifest.json")) {
            Write-Error "Packages manifest not found!"
            exit 1
          }
          Write-Host "‚úì Project structure is valid"
      
      - name: Validate manifest.json
        run: |
          $manifest = Get-Content "DragRaceUnity/Packages/manifest.json" -Raw | ConvertFrom-Json
          Write-Host "‚úì Found $($manifest.dependencies.PSObject.Properties.Count) packages"
          $manifest.dependencies.PSObject.Properties.Name | ForEach-Object {
            Write-Host "  - $_"
          }

  # =============================================================================
  # –ó–∞–¥–∞—á–∞ 2: –°–±–æ—Ä–∫–∞ –¥–ª—è Windows
  # =============================================================================
  build-windows:
    name: Build for Windows
    runs-on: windows-latest
    timeout-minutes: 60
    needs: [validate]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: DragRaceUnity/Library
          key: Library-${{ hashFiles('DragRaceUnity/Assets/**', 'DragRaceUnity/Packages/**') }}
          restore-keys: |
            Library-
      
      - name: Create Build Script
        run: |
          @'
          using UnityEngine;
          using UnityEditor;
          using System;
          using System.IO;
          using System.Linq;

          namespace DragRaceUnity.EditorTools
          {
              public static class CIBuildScript
              {
                  public static void PerformBuild()
                  {
                      Debug.Log("=== CI/CD Build Started ===");
                      
                      // –ü–æ–ª—É—á–∞–µ–º —Å—Ü–µ–Ω—ã –∏–∑ Build Settings
                      var scenes = EditorBuildSettings.scenes
                          .Where(s => s.enabled)
                          .Select(s => s.path)
                          .ToArray();
                      
                      if (scenes.Length == 0)
                      {
                          Debug.LogError("No scenes found in Build Settings!");
                          throw new Exception("No scenes in build settings");
                      }
                      
                      Debug.Log($"Scenes: {string.Join(", ", scenes)}");
                      
                      // –ü—É—Ç—å –∫ —Å–±–æ—Ä–∫–µ
                      string buildPath = Path.Combine(
                          Directory.GetCurrentDirectory(), 
                          "..", 
                          "Builds", 
                          "GitHub-Actions", 
                          "DragRace_Windows.exe"
                      );
                      
                      Directory.CreateDirectory(Path.GetDirectoryName(buildPath));
                      Debug.Log($"Build Path: {buildPath}");
                      
                      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Player Settings
                      PlayerSettings.companyName = "DragRace Studio";
                      PlayerSettings.productName = "DragRace";
                      PlayerSettings.bundleVersion = "1.0." + DateTime.Now.ToString("yyMMdd");
                      PlayerSettings.defaultScreenWidth = 1920;
                      PlayerSettings.defaultScreenHeight = 1080;
                      PlayerSettings.fullScreenMode = FullScreenMode.Windowed;
                      
                      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±–æ—Ä–∫–∏
                      BuildPlayerOptions buildPlayerOptions = new BuildPlayerOptions();
                      buildPlayerOptions.scenes = scenes;
                      buildPlayerOptions.locationPathName = buildPath;
                      buildPlayerOptions.target = BuildTarget.StandaloneWindows64;
                      buildPlayerOptions.options = BuildOptions.None;
                      
                      Debug.Log("Starting build...");
                      BuildPipeline.BuildPlayer(buildPlayerOptions);
                      
                      if (File.Exists(buildPath))
                      {
                          Debug.Log("=== BUILD SUCCESS ===");
                          Debug.Log($"Output: {buildPath}");
                          Debug.Log($"Size: {new FileInfo(buildPath).Length / (1024 * 1024)} MB");
                      }
                      else
                      {
                          throw new Exception("Build failed - executable not found!");
                      }
                  }
              }
          }
          '@ | Out-File -FilePath "DragRaceUnity/Assets/Scripts/Editor/CIBuildScript.cs" -Encoding UTF8
          
          Write-Host "‚úì Build script created"
      
      - name: Build Unity Project
        run: |
          $unityPath = "C:\Program Files\Unity\Hub\Editor\${{ env.UNITY_VERSION }}\Editor\Unity.exe"
          
          if (!(Test-Path $unityPath)) {
            Write-Error "Unity not found at $unityPath"
            exit 1
          }
          
          Write-Host "Starting Unity Build..."
          Write-Host "Unity: $unityPath"
          Write-Host "Project: ${{ env.PROJECT_PATH }}"
          
          & $unityPath `
            -batchmode `
            -nographics `
            -quit `
            -projectPath "${{ env.PROJECT_PATH }}" `
            -executeMethod "DragRaceUnity.EditorTools.CIBuildScript.PerformBuild" `
            -logFile "build-unity.log"
          
          $exitCode = $LASTEXITCODE
          
          # –í—ã–≤–æ–¥ –ª–æ–≥–∞
          if (Test-Path "build-unity.log") {
            Get-Content "build-unity.log" | Select-String "error|Error|SUCCESS|FAILED" | Select-Object -Last 20
          }
          
          if ($exitCode -ne 0) {
            Write-Error "Unity build failed with exit code $exitCode"
            exit $exitCode
          }
          
          Write-Host "‚úì Build completed successfully"
      
      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DragRace-Windows-Build
          path: Builds/GitHub-Actions/
          retention-days: 30
          if-no-files-found: error
      
      - name: Create Build Summary
        if: always()
        run: |
          $buildFile = Get-Item "Builds/GitHub-Actions/DragRace_Windows.exe" -ErrorAction SilentlyContinue
          
          $summary = @"
          ## üéÆ Unity Build Summary
          
          ### üìä Build Info
          - **Unity Version:** ${{ env.UNITY_VERSION }}
          - **Platform:** Windows x64
          - **Configuration:** ${{ github.event.inputs.build_configuration || 'Release' }}
          - **Commit:** ${{ github.sha }}
          - **Trigger:** ${{ github.event_name }}
          
          ### üì¶ Build Output
          - **File:** DragRace_Windows.exe
          - **Size:** $(if ($buildFile) { "{0:N2} MB" -f ($buildFile.Length / 1MB) } else { "N/A" })
          - **Status:** $(if ($buildFile) { "‚úÖ Success" } else { "‚ùå Failed" })
          
          ### üîó Links
          - [Download Artifact](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8

  # =============================================================================
  # –ó–∞–¥–∞—á–∞ 3: –°–±–æ—Ä–∫–∞ –¥–ª—è WebGL (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  # =============================================================================
  build-webgl:
    name: Build for WebGL
    runs-on: windows-latest
    timeout-minutes: 60
    needs: [validate]
    if: false # –û—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true
      
      - name: Cache Library
        uses: actions/cache@v4
        with:
          path: DragRaceUnity/Library
          key: Library-WebGL-${{ hashFiles('DragRaceUnity/Assets/**') }}
          restore-keys: |
            Library-WebGL-
      
      - name: Build WebGL
        run: |
          $unityPath = "C:\Program Files\Unity\Hub\Editor\${{ env.UNITY_VERSION }}\Editor\Unity.exe"
          
          & $unityPath `
            -batchmode `
            -nographics `
            -quit `
            -projectPath "${{ env.PROJECT_PATH }}" `
            -executeMethod "BuildScript.PerformWebGLBuild" `
            -logFile "build-webgl.log"
      
      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: DragRace-WebGL-Build
          path: Builds/WebGL/
          retention-days: 30

  # =============================================================================
  # –ó–∞–¥–∞—á–∞ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞ (–ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)
  # =============================================================================
  release:
    name: Create Release
    runs-on: windows-latest
    needs: [build-windows]
    if: github.event_name == 'release'
    
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: DragRace-Windows-Build
          path: ./ReleaseBuild/
      
      - name: Create ZIP Archive
        run: |
          Compress-Archive -Path ./ReleaseBuild/* -DestinationPath ./DragRace_Windows.zip -Force
          Write-Host "‚úì Created DragRace_Windows.zip"
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          files: ./DragRace_Windows.zip
          token: ${{ secrets.GITHUB_TOKEN }}
