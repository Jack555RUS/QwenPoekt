# ============================================================
# GitHub Actions для DragRaceUnity
# Автоматическая сборка и тестирование
# ============================================================
name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # ============================================================
  # Задача 1: Тестирование
  # ============================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      # Checkout кода
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true
      
      # Кэширование Library
      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: DragRaceUnity/Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
      
      # Запуск тестов (через Unity CLI)
      - name: Run Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: DragRaceUnity
          unityVersion: 2022.3.10f1
          testMode: EditMode
          artifactsPath: TestResults
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      
      # Загрузка результатов тестов
      - name: Upload Test Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: TestResults
          path: TestResults

  # ============================================================
  # Задача 2: Сборка для Windows
  # ============================================================
  build-windows:
    name: Build Windows
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [test]
    
    steps:
      # Checkout кода
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true
      
      # Кэширование Library
      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: DragRaceUnity/Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
      
      # Сборка через Unity
      - name: Build Windows
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: DragRaceUnity
          unityVersion: 2022.3.10f1
          targetPlatform: StandaloneWindows64
          buildPath: DragRaceUnity/Builds
          versioning: ${{ github.run_number }}
      
      # Загрузка билда
      - name: Upload Build
        uses: actions/upload-artifact@v3
        with:
          name: DragRace-Windows-Build
          path: DragRaceUnity/Builds

  # ============================================================
  # Задача 3: Сборка для WebGL
  # ============================================================
  build-webgl:
    name: Build WebGL
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [test]
    
    steps:
      # Checkout кода
      - name: Checkout
        uses: actions/checkout@v3
        with:
          lfs: true
      
      # Кэширование Library
      - name: Cache Library
        uses: actions/cache@v3
        with:
          path: DragRaceUnity/Library
          key: Library-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-
      
      # Сборка через Unity
      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: DragRaceUnity
          unityVersion: 2022.3.10f1
          targetPlatform: WebGL
          buildPath: DragRaceUnity/Builds/WebGL
      
      # Загрузка билда
      - name: Upload WebGL Build
        uses: actions/upload-artifact@v3
        with:
          name: DragRace-WebGL-Build
          path: DragRaceUnity/Builds/WebGL

  # ============================================================
  # Задача 4: Анализ кода
  # ============================================================
  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # Checkout кода
      - name: Checkout
        uses: actions/checkout@v3
      
      # Анализ C# кода
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'
      
      # Проверка стиля кода
      - name: Code Style Check
        run: |
          echo "Checking C# code style..."
          # TODO: Добавить analyzers если нужно
      
      # Поиск проблем
      - name: Find Issues
        run: |
          echo "Scanning for common issues..."
          grep -r "TODO" DragRaceUnity/Assets/Scripts/ || true
          grep -r "FIXME" DragRaceUnity/Assets/Scripts/ || true
          grep -r "HACK" DragRaceUnity/Assets/Scripts/ || true

  # ============================================================
  # Задача 5: Деплой (только для main)
  # ============================================================
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-windows, build-webgl]
    if: github.ref == 'refs/heads/main'
    
    steps:
      # Загрузка артефактов
      - name: Download Builds
        uses: actions/download-artifact@v3
        with:
          name: DragRace-Windows-Build
          path: ./builds/windows
      
      # Создание релиза
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            builds/windows/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
